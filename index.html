<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta http-equiv="refresh" content="300">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gordon ‚Äî Trading Dashboard</title>
  <link rel="icon" href="assets/gordon-logo.svg">
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <nav class="nav">
    <a href="index.html" class="nav-brand"><img src="assets/gordon-logo.svg" alt="G">gordon.money</a>
    <div class="nav-links">
      <a href="index.html" class="active">Overview</a>
      <a href="strategies.html">Strategies</a>
      <a href="predictions.html">Predictions</a>
      <a href="signals.html">Signals</a>
      <a href="worldview.html">Worldview</a>
    </div>
    <span class="timestamp" id="lastUpdated"></span>
    <span class="timestamp" id="refreshCountdown" style="margin-left:12px;color:var(--text-dim,#888);font-size:0.75rem"></span>
  </nav>
  <div class="container" id="content">
    <div class="loading">Loading dashboard data</div>
  </div>
  <footer class="footer">Powered by Gordon üí∞ | Data updates every 12h | Not financial advice</footer>
  <script src="assets/charts.js"></script>
  <script>
fetch('data/dashboard.json?t='+Date.now()).then(r=>r.json()).then(data=>{
  console.log('Dashboard data:', data);
  try {
  document.getElementById('lastUpdated').textContent='Updated: '+fmtDate(data.generated_at);
  const c=document.getElementById('content');
  const s=data.market_mood;
  const composite = s.composite || 0;
  const cnnVal = (s.cnn_fear_greed && s.cnn_fear_greed.value) || 0;
  const cnnLabel = (s.cnn_fear_greed && s.cnn_fear_greed.label) || '‚Äî';
  const cryptoVal = (s.crypto_fear_greed && s.crypto_fear_greed.value) || 0;
  const cryptoLabel = (s.crypto_fear_greed && s.crypto_fear_greed.label) || '‚Äî';
  const vixVal = (s.vix && s.vix.value) || 0;
  const vixLabel = (s.vix && s.vix.label) || 'Normal';
  const gtComposite = (s.google_trends && s.google_trends.composite) || 0;
  const ps = data.pipeline_status || {};

  c.innerHTML=`
  <div class="grid grid-overview" style="gap:20px;margin-bottom:20px;align-items:stretch">
    <div class="card" style="display:flex;flex-direction:column;justify-content:center">
      <div class="card-title">Market Mood</div>
      <div class="gauge-container" style="flex:1;display:flex;flex-direction:column;justify-content:center">
        <canvas id="moodGauge" height="90"></canvas>
        <div class="gauge-value" style="color:${sentimentColor(composite)};font-size:1.5rem">${composite.toFixed(2)}</div>
        <div class="gauge-label">${composite<-0.3?'Fear':composite>0.3?'Greed':'Neutral'} ‚Äî Composite Sentiment</div>
      </div>
    </div>
    <div>
      <div class="grid grid-4" style="margin-bottom:20px">
        <div class="card metric-card">
          <div class="card-title">CNN Fear & Greed</div>
          <div class="card-value">${cnnVal.toFixed(1)}</div>
          <div class="card-label">${cnnLabel}</div>
        </div>
        <div class="card metric-card">
          <div class="card-title">Crypto F&G</div>
          <div class="card-value" style="color:${cryptoVal<25?'var(--red)':'var(--gold)'}">${cryptoVal}</div>
          <div class="card-label">${cryptoLabel}</div>
        </div>
        <div class="card metric-card">
          <div class="card-title">VIX</div>
          <div class="card-value">${vixVal.toFixed(2)}</div>
          <div class="card-label">${vixVal>20?'Elevated':'Normal'} Volatility</div>
        </div>
        <div class="card metric-card">
          <div class="card-title">Google Trends</div>
          <div class="card-value">${gtComposite>=0?'+':''}${gtComposite.toFixed(2)}</div>
          <div class="card-label">Search Sentiment</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Pipeline Status</div>
        <div style="display:flex;gap:24px;flex-wrap:wrap;align-items:center">
          <div><span class="status-dot ${(ps.steps_failed||0)===0?'green':'red'}"></span>${ps.status ? ps.status.toUpperCase() : ((ps.steps_failed||0)===0?'OK':'ERROR')}</div>
          <div><span style="color:var(--text-dim)">Steps:</span> ${ps.steps_completed||0}${ps.steps_total ? '/'+ps.steps_total : ''}</div>
          <div><span style="color:var(--text-dim)">Duration:</span> ${ps.elapsed_seconds ? ps.elapsed_seconds.toFixed(0)+'s' : '‚Äî'}</div>
          <div><span style="color:var(--text-dim)">Last:</span> ${fmtDate(ps.last_run)}</div>
          <div><span style="color:var(--text-dim)">Next:</span> ${fmtDate(data.next_update)}</div>
        </div>
      </div>
    </div>
  </div>

  ${(()=>{const ps=data.portfolio_summary||{};const pnl=ps.total_pnl||0;const pnlPct=ps.total_pnl_pct||0;const clr=pnl>=0?'var(--green,#4caf50)':'var(--red,#f44336)';return `
  <div class="grid grid-4" style="margin-bottom:20px">
    <div class="card metric-card"><div class="card-title">Total Invested</div><div class="card-value">${fmt$(ps.total_invested)}</div></div>
    <div class="card metric-card"><div class="card-title">Current Value</div><div class="card-value">${fmt$(ps.total_current_value)}</div></div>
    <div class="card metric-card"><div class="card-title">Total P&L</div><div class="card-value" style="color:${clr}">${pnl>=0?'+':''}${fmt$(pnl)}</div></div>
    <div class="card metric-card"><div class="card-title">P&L %</div><div class="card-value" style="color:${clr}">${pnl>=0?'+':''}${pnlPct.toFixed(2)}%</div></div>
  </div>`;})()}

  <div class="card" style="margin-bottom:20px">
    <div class="card-title">Active Positions</div>
    <div class="table-wrap"><table>
      <thead><tr><th>Symbol</th><th>Direction</th><th>Entry</th><th>Current</th><th>Amount</th><th>Leverage</th><th>P&L ($)</th><th>P&L (%)</th><th>Strategy</th></tr></thead>
      <tbody>${(data.positions||[]).map(p=>{const pclr=(p.pnl_dollar||0)>=0?'var(--green,#4caf50)':'var(--red,#f44336)';return `<tr>
        <td><strong>${p.symbol}</strong></td>
        <td>${dirBadge(p.direction||'‚Äî')}</td>
        <td>${fmt$(p.entry_price)}</td>
        <td>${p.current_price!=null?fmt$(p.current_price):'‚Äî'}</td>
        <td>${fmt$(p.amount)}</td>
        <td>${p.leverage||1}x</td>
        <td style="color:${pclr};font-weight:600">${p.pnl_dollar!=null?((p.pnl_dollar>=0?'+':'')+fmt$(p.pnl_dollar)):'‚Äî'}</td>
        <td style="color:${pclr};font-weight:600">${p.pnl_percent!=null?((p.pnl_percent>=0?'+':'')+p.pnl_percent.toFixed(2)+'%'):'‚Äî'}</td>
        <td>${stratBadge(p.strategy||'‚Äî')}</td>
      </tr>`}).join('')}</tbody>
    </table></div>
  </div>

  <div class="grid grid-2">
    <div class="card">
      <div class="card-title">Top Signals</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Symbol</th><th>Type</th><th>Conviction</th><th>Date</th></tr></thead>
        <tbody>${((data.signals&&data.signals.top_signals)||[]).slice(0,5).map(sg=>`<tr>
          <td><strong>${sg.symbol||'‚Äî'}</strong></td>
          <td>${sg.type||sg.source||'‚Äî'}</td>
          <td style="color:${(sg.conviction||0)>60?'var(--green)':'var(--gold)'}">${sg.conviction!=null ? sg.conviction.toFixed(0)+'%' : sg.score!=null ? sg.score.toFixed(2) : '‚Äî'}</td>
          <td class="timestamp">${fmtDate(sg.timestamp||sg.created_at)}</td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>
    <div class="card">
      <div class="card-title">Recent Trades</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Symbol</th><th>Side</th><th>Entry</th><th>P&L</th><th>Strategy</th><th>Date</th></tr></thead>
        <tbody>${(data.recent_trades||[]).slice(0,10).map(t=>`<tr>
          <td><strong>${t.symbol}</strong></td>
          <td>${dirBadge(t.side||t.direction||'‚Äî')}</td>
          <td>${fmt$(t.entry_price)}</td>
          <td class="${pnlClass(t.pnl)}">${t.pnl!=null ? fmt$(t.pnl) : '‚Äî'}</td>
          <td>${stratBadge(t.strategy||'‚Äî')}</td>
          <td class="timestamp">${fmtDate(t.exit_time||t.entry_time||t.opened_at)}</td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>
  </div>

  ${renderMarketRegime(data.market_regime)}
  
  <div class="grid grid-2" style="margin-top:20px">
    ${renderTwitterSentiment(data.twitter_sentiment)}
    ${renderSignalHeatmap(data.signal_heatmap)}
  </div>`;

  renderGauge('moodGauge', composite, -1, 1, 'Sentiment');
  } catch(e) {
    console.error('Dashboard render error:', e);
    document.getElementById('content').innerHTML='<div class="loading">Error rendering dashboard: '+e.message+'</div>';
  }
}).catch(e=>{console.error('Fetch error:',e);document.getElementById('content').innerHTML='<div class="loading">Failed to load data</div>';});

/* RENDER NEW PANELS */
function renderMarketRegime(regime) {
  if (!regime) return '<div class="card"><div class="card-title">üéØ Market Regime</div><div style="padding:20px;color:var(--text-dim)">No regime data available</div></div>';
  
  const regimeColors = {
    'TRENDING_UP': 'var(--green)',
    'TRENDING_DOWN': 'var(--red)',
    'MEAN_REVERTING': 'var(--blue)',
    'TRANSITION': '#ff9800',
    'CRISIS': 'var(--red)'
  };
  const bgColor = regimeColors[regime.regime] || 'var(--card)';
  const confidence = regime.confidence > 1 ? regime.confidence.toFixed(1) : (regime.confidence * 100).toFixed(1);
  
  return `<div class="card" style="margin-top:20px;background:linear-gradient(135deg, ${bgColor}22, var(--card));border-color:${bgColor}55">
    <div class="card-title">üéØ Market Regime</div>
    <div style="text-align:center;padding:24px 16px">
      <div style="font-size:2.5rem;font-weight:700;color:${bgColor};margin-bottom:8px">${regime.regime.replace(/_/g, ' ')}</div>
      <div style="font-size:1.2rem;color:var(--text-dim);margin-bottom:16px">${confidence}% Confidence</div>
      <div style="display:inline-block;padding:8px 16px;background:${bgColor}33;border-radius:8px;margin-bottom:16px">
        <span style="color:var(--text-dim)">Sizing Multiplier:</span> 
        <span style="font-size:1.4rem;font-weight:600;color:${bgColor};margin-left:8px">${regime.sizing_multiplier}x</span>
      </div>
      ${regime.description ? `<div style="color:var(--text);margin-top:16px;font-size:0.9rem;line-height:1.6">${regime.description}</div>` : ''}
      ${regime.indicators && Object.keys(regime.indicators).length > 0 ? `
        <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--card-border)">
          <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:12px">Key Indicators</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;text-align:left">
            ${Object.entries(regime.indicators).map(([key, val]) => `
              <div style="background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:6px">
                <div style="font-size:0.7rem;color:var(--text-dim);text-transform:uppercase">${key.replace(/_/g, ' ')}</div>
                <div style="font-size:1rem;font-weight:600;color:var(--text);margin-top:2px">${typeof val === 'object' && val !== null ? (val.score != null ? val.score.toFixed(2) : JSON.stringify(val)) : typeof val === 'number' ? val.toFixed(3) : val}</div>
                ${typeof val === 'object' && val && val.detail ? `<div style="font-size:0.65rem;color:var(--text-dim);margin-top:2px">${val.detail}</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  </div>`;
}

function renderTwitterSentiment(sentiment) {
  if (!sentiment) {
    return '<div class="card"><div class="card-title">üê¶ Twitter Sentiment</div><div style="padding:20px;color:var(--text-dim)">No sentiment data available</div></div>';
  }
  
  // Handle both array and object formats
  const rawItems = Array.isArray(sentiment) ? sentiment : (sentiment.instruments || []);
  if (!rawItems.length) {
    return '<div class="card"><div class="card-title">üê¶ Twitter Sentiment</div><div style="padding:20px;color:var(--text-dim)">No sentiment data available</div></div>';
  }
  
  // Convert to array and sort by absolute score
  const items = rawItems.map(data => ({
    symbol: data.instrument || '‚Äî',
    score: data.score || 0,
    volume: data.volume || 0,
    bull: data.bull_count || 0,
    bear: data.bear_count || 0,
    fear: Math.round((data.fear_level || 0) * 100),
    greed: Math.round((data.greed_level || 0) * 100)
  })).sort((a, b) => Math.abs(b.score) - Math.abs(a.score));
  
  function scoreColor(score) {
    if (score > 0.1) return 'var(--green)';
    if (score < -0.1) return 'var(--red)';
    return 'var(--text-dim)';
  }
  
  return `<div class="card">
    <div class="card-title">üê¶ Twitter Sentiment</div>
    <div class="table-wrap"><table>
      <thead><tr>
        <th>Symbol</th>
        <th>Score</th>
        <th>Volume</th>
        <th>Bull</th>
        <th>Bear</th>
        <th>Fear</th>
        <th>Greed</th>
      </tr></thead>
      <tbody>${items.map(item => `<tr>
        <td><strong>${item.symbol}</strong></td>
        <td style="color:${scoreColor(item.score)};font-weight:600">${item.score >= 0 ? '+' : ''}${item.score.toFixed(2)}</td>
        <td>${item.volume}</td>
        <td style="color:var(--green)">${item.bull}</td>
        <td style="color:var(--red)">${item.bear}</td>
        <td style="color:${item.fear > 15 ? 'var(--red)' : 'var(--text)'};${item.fear > 15 ? 'font-weight:600' : ''}">${item.fear}%</td>
        <td style="color:${item.greed > 15 ? 'var(--green)' : 'var(--text)'};${item.greed > 15 ? 'font-weight:600' : ''}">${item.greed}%</td>
      </tr>`).join('')}</tbody>
    </table></div>
  </div>`;
}

function renderSignalHeatmap(heatmap) {
  const grid = heatmap ? (heatmap.grid || heatmap.data || []) : [];
  if (!grid.length) {
    return '<div class="card"><div class="card-title">üì° Signal Heatmap (24h)</div><div style="padding:20px;color:var(--text-dim)">No signal data available</div></div>';
  }
  
  // Use top 3 signal types by count to keep table compact
  const allTypes = heatmap.signal_types || Array.from(new Set(grid.flatMap(row => Object.keys(row.signals || {})))).sort();
  const counts = heatmap.signal_counts || {};
  const types = allTypes.filter(t => counts[t]).sort((a,b) => (counts[b]||0) - (counts[a]||0)).slice(0, 3);
  
  // Use provided signal_counts or calculate
  const totals = heatmap.signal_counts || {};
  if (!Object.keys(totals).length) {
    types.forEach(type => {
      totals[type] = grid.reduce((sum, row) => sum + (row.signals[type] ? 1 : 0), 0);
    });
  }
  
  function convictionColor(conviction) {
    if (!conviction) return 'rgba(255,255,255,0.03)';
    const intensity = Math.min(conviction, 1.0);
    const r = Math.round(212 * intensity);
    const g = Math.round(175 * intensity);
    const b = Math.round(55 * intensity);
    return `rgba(${r}, ${g}, ${b}, ${0.2 + intensity * 0.6})`;
  }
  
  return `<div class="card">
    <div class="card-title">üì° Signal Heatmap (24h)</div>
    <div class="table-wrap"><table style="font-size:0.8rem">
      <thead><tr>
        <th style="position:sticky;left:0;background:var(--card);z-index:1">Symbol</th>
        ${types.map(type => `<th style="text-align:center">${type}</th>`).join('')}
      </tr></thead>
      <tbody>
        ${grid.map(row => `<tr>
          <td style="position:sticky;left:0;background:var(--card);font-weight:600;z-index:1"><strong>${row.instrument||row.symbol}</strong></td>
          ${types.map(type => {
            const val = (row.signals||{})[type];
            const conviction = typeof val === 'object' ? (val ? val.conviction||0 : 0) : (val||0);
            const normConv = conviction > 1 ? conviction/100 : conviction;
            return `<td style="text-align:center;background:${convictionColor(normConv)};padding:10px 8px">
              ${conviction > 0 ? `<div style="font-weight:600;color:var(--text)">${conviction > 1 ? conviction.toFixed(0) : conviction.toFixed(2)}</div>` : '‚Äî'}
            </td>`;
          }).join('')}
        </tr>`).join('')}
        <tr style="border-top:2px solid var(--card-border);font-weight:600">
          <td style="position:sticky;left:0;background:var(--card);z-index:1;color:var(--gold)">TOTAL</td>
          ${types.map(type => `<td style="text-align:center;color:var(--gold)">${totals[type]}</td>`).join('')}
        </tr>
      </tbody>
    </table></div>
  </div>`;
}
  </script>

<script>
// Auto-refresh countdown
(function(){
  var total=300, left=total;
  var el=document.getElementById('refreshCountdown');
  if(!el) return;
  setInterval(function(){
    left--;
    if(left<0) left=0;
    var m=Math.floor(left/60), s=left%60;
    el.textContent='Next refresh in '+m+'m '+s+'s';
  },1000);
})();
</script>
</body>
</html>